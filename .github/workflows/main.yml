name: Docker Auto Push and Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-push:
    runs-on: self-hosted
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 关键步骤：使用最稳健的 PowerShell 登录语法
      - name: Login to Docker Hub
        shell: powershell
        run: |
          # 1. 强制去除可能存在的任何空格
          $token = "${{ secrets.DOCKER_PASSWORD }}".Trim()
          
          # 2. 如果 Token 为空，直接报错停止，不再盲目执行
          if ([string]::IsNullOrWhiteSpace($token)) {
              Write-Error "错误：GitHub Secrets 中的 DOCKER_PASSWORD 似乎没有配置成功！"
              exit 1
          }

          # 3. 使用特定的管道流，确保不带任何多余字符传给 Docker
          $token | docker login -u "cx0512" --password-stdin

      - name: Build and Push
        shell: powershell
        run: |
          # 一次性构建并打上 latest 标签
          docker build -t cx0512/my-web-app:latest .
          # 推送至云端
          docker push cx0512/my-web-app:latest

      - name: Local Deploy
        shell: powershell
        run: |
          # 幂等性清理并启动
          docker stop my-web-site 2>$null
          docker rm my-web-site 2>$null
          docker run -d --name my-web-site -p 8080:80 cx0512/my-web-app:latest
